<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visitor Tracking Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 { color: #333; }
    .status { 
      padding: 10px; 
      margin: 10px 0; 
      border-radius: 4px;
      font-weight: bold;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    button:hover { background: #0056b3; }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .log {
      margin: 5px 0;
      padding: 8px;
      background: #f8f9fa;
      border-left: 3px solid #007bff;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîç Visitor Tracking Test</h1>
    <p>This page tests if visitor tracking is working correctly.</p>
  </div>

  <div class="card">
    <h2>Test Configuration</h2>
    <div id="config"></div>
  </div>

  <div class="card">
    <h2>Test Results</h2>
    <button onclick="runTest()">üöÄ Run Test</button>
    <div id="results" style="margin-top: 20px;"></div>
  </div>

  <div class="card">
    <h2>Live Logs</h2>
    <div id="logs"></div>
  </div>

  <script>
    // Your Supabase config
    const SUPABASE_URL = 'https://njdmmnvdjoawckvoxcxd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qZG1tbnZkam9hd2Nrdm94Y3hkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5Mjg5NDMsImV4cCI6MjA3OTUwNDk0M30.dRdM5CtWvkX_dpTIE7Hqu9WyslEiirMwqHeiatNVu6U';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Display config
    document.getElementById('config').innerHTML = `
      <pre>SUPABASE_URL: ${SUPABASE_URL}
Anon Key: ${SUPABASE_ANON_KEY.substring(0, 20)}...</pre>
    `;

    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff';
      logsDiv.innerHTML = `<div class="log" style="border-left-color: ${color}">[${timestamp}] ${message}</div>` + logsDiv.innerHTML;
      console.log(`[${timestamp}] ${message}`);
    }

    async function runTest() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="info">Running tests...</div>';
      
      log('üöÄ Starting visitor tracking test...');

      try {
        // Test 1: Check if table exists
        log('üìã Test 1: Checking if visitor_events table exists...');
        const { data: tableCheck, error: tableError } = await supabase
          .from('visitor_events')
          .select('*')
          .limit(1);

        if (tableError) {
          if (tableError.code === '42P01') {
            resultsDiv.innerHTML = '<div class="error">‚ùå FAIL: Table "visitor_events" does not exist!</div>';
            log('‚ùå Table does not exist', 'error');
            return;
          } else {
            resultsDiv.innerHTML = `<div class="error">‚ùå Error: ${tableError.message} (Code: ${tableError.code})</div>`;
            log(`‚ùå Error accessing table: ${tableError.message}`, 'error');
            return;
          }
        }

        log('‚úÖ Table exists', 'success');

        // Test 2: Try to insert a visitor event
        log('‚úçÔ∏è  Test 2: Attempting to insert a test visitor event...');
        
        const testSessionId = `test_${Date.now()}`;
        const testData = {
          session_id: testSessionId,
          page_path: '/test-page',
          referrer: 'test-html',
          user_agent: navigator.userAgent,
          city: 'Test City',
          region: 'Test Region',
          country: 'Test Country',
        };

        log(`Inserting: ${JSON.stringify(testData, null, 2)}`);

        const { data: insertData, error: insertError } = await supabase
          .from('visitor_events')
          .insert(testData)
          .select();

        if (insertError) {
          resultsDiv.innerHTML = `
            <div class="error">
              <strong>‚ùå FAIL: Cannot insert records</strong><br><br>
              <strong>Error:</strong> ${insertError.message}<br>
              <strong>Code:</strong> ${insertError.code}<br>
              ${insertError.code === '42501' ? '<br><strong>‚ö†Ô∏è This is an RLS policy issue!</strong><br>Run fix_visitor_events_rls.sql to fix.' : ''}
            </div>
          `;
          log(`‚ùå Insert failed: ${insertError.message} (Code: ${insertError.code})`, 'error');
          
          if (insertError.code === '42501') {
            log('‚ö†Ô∏è  RLS POLICY ERROR - Anonymous users cannot insert!', 'error');
          }
          return;
        }

        log(`‚úÖ Successfully inserted record: ${insertData[0].id}`, 'success');

        // Test 3: Try to read it back
        log('üìñ Test 3: Reading back the test record...');
        const { data: readData, error: readError } = await supabase
          .from('visitor_events')
          .select('*')
          .eq('session_id', testSessionId)
          .single();

        if (readError) {
          resultsDiv.innerHTML = `<div class="error">‚ùå Could not read back the record: ${readError.message}</div>`;
          log(`‚ùå Read failed: ${readError.message}`, 'error');
          return;
        }

        log('‚úÖ Successfully read record back', 'success');

        // Test 4: Clean up
        log('üóëÔ∏è  Test 4: Cleaning up test record...');
        const { error: deleteError } = await supabase
          .from('visitor_events')
          .delete()
          .eq('session_id', testSessionId);

        if (deleteError) {
          log(`‚ö†Ô∏è  Could not delete test record: ${deleteError.message}`, 'error');
        } else {
          log('‚úÖ Test record cleaned up', 'success');
        }

        // Success!
        resultsDiv.innerHTML = `
          <div class="success">
            <strong>‚úÖ ALL TESTS PASSED!</strong><br><br>
            Visitor tracking is working correctly.<br>
            Inserted record ID: ${insertData[0].id}<br><br>
            <strong>Next steps:</strong><br>
            1. Visit your live site<br>
            2. Check /studio/analytics<br>
            3. You should see visitor data populating
          </div>
        `;
        
        log('üéâ All tests passed! Visitor tracking is working!', 'success');

      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">‚ùå Unexpected error: ${error.message}</div>`;
        log(`‚ùå Unexpected error: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // Auto-run test on page load
    window.addEventListener('load', () => {
      log('Page loaded, ready to test');
    });
  </script>
</body>
</html>
